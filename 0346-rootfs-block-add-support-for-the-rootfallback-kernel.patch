From 40586a2b7b272d273b5d5815c90254501336b8dc Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 28 May 2014 15:41:40 +0200
Subject: [PATCH] rootfs-block: add support for the rootfallback= kernel
 cmdline option

backport of the rootfallback= kernel cmdline option

https://bugzilla.redhat.com/show_bug.cgi?id=737687
---
 dracut.8                                 |  3 +++
 modules.d/95rootfs-block/install         |  2 ++
 modules.d/95rootfs-block/rootfallback.sh | 46 ++++++++++++++++++++++++++++++++
 3 files changed, 51 insertions(+)
 create mode 100755 modules.d/95rootfs-block/rootfallback.sh

diff --git a/dracut.8 b/dracut.8
index 95bd0a3..3c58453 100644
--- a/dracut.8
+++ b/dracut.8
@@ -137,6 +137,9 @@ specify additional mount options for the root filesystem. If not set, /etc/fstab
 of the real root will be parsed for special mount options and mounted 
 accordingly.
 .TP
+\fBrootfallback=\fR\fI<path to blockdevice>\fR
+specify the block device to use as the root filesystem, if the normal root cannot be found\&. This can only be a simple block device with a simple file system, for which the filesystem driver is either compiled in, or added manually to the initramfs\&. This parameter can be specified multiple times\&.
+.TP
 .B rd_NO_FSTAB
 do not honor special mount options for the root filesystem found in 
 /etc/fstab of the real root.
diff --git a/modules.d/95rootfs-block/install b/modules.d/95rootfs-block/install
index 9fdc121..8152ea0 100755
--- a/modules.d/95rootfs-block/install
+++ b/modules.d/95rootfs-block/install
@@ -3,3 +3,5 @@ dracut_install umount
 inst_hook cmdline 95 "$moddir/parse-block.sh"
 inst_hook pre-udev 30 "$moddir/block-genrules.sh"
 inst_hook mount 99 "$moddir/mount-root.sh"
+inst_hook initqueue/timeout 99 "$moddir/rootfallback.sh"
+
diff --git a/modules.d/95rootfs-block/rootfallback.sh b/modules.d/95rootfs-block/rootfallback.sh
new file mode 100755
index 0000000..246ce9a
--- /dev/null
+++ b/modules.d/95rootfs-block/rootfallback.sh
@@ -0,0 +1,46 @@
+#!/bin/sh
+# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
+# ex: ts=8 sw=4 sts=4 et filetype=sh
+
+type getarg >/dev/null 2>&1 || . /lib/dracut-lib.sh
+
+for root in $(getargs rootfallback=); do
+    case "$root" in
+        block:LABEL=*|LABEL=*)
+            root="${root#block:}"
+            root="$(echo $root | sed 's,/,\\x2f,g')"
+            root="/dev/disk/by-label/${root#LABEL=}"
+            ;;
+        block:UUID=*|UUID=*)
+            root="${root#block:}"
+            root="${root#UUID=}"
+            root="$(echo $root | tr "[:upper:]" "[:lower:]")"
+            root="/dev/disk/by-uuid/${root#UUID=}"
+            ;;
+        block:PARTUUID=*|PARTUUID=*)
+            root="${root#block:}"
+            root="${root#PARTUUID=}"
+            root="$(echo $root | tr "[:upper:]" "[:lower:]")"
+            root="/dev/disk/by-partuuid/${root}"
+            ;;
+        block:PARTLABEL=*|PARTLABEL=*)
+            root="${root#block:}"
+            root="/dev/disk/by-partlabel/${root#PARTLABEL=}"
+            ;;
+    esac
+
+    if ! [ -b "$root" ]; then
+        warn "Could not find rootfallback $root"
+        continue
+    fi
+
+    if mount "$root" /sysroot; then
+        info "Mounted rootfallback $root"
+        exit 0
+    else
+        warn "Failed to mount rootfallback $root"
+        exit 1
+    fi
+done
+
+[ -e "$job" ] && rm -f "$job"
