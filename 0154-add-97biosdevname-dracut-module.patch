From 26c4321fa981b14d6c07badf6dbbb0f12dc9634a Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 26 Jan 2011 12:58:52 +0100
Subject: [PATCH] add 97biosdevname dracut module

---
 dracut.8                                     |  4 +++-
 modules.d/97biosdevname/check                |  7 +++++++
 modules.d/97biosdevname/install              | 14 ++++++++++++++
 modules.d/97biosdevname/parse-biosdevname.sh | 11 +++++++++++
 4 files changed, 35 insertions(+), 1 deletion(-)
 create mode 100755 modules.d/97biosdevname/check
 create mode 100755 modules.d/97biosdevname/install
 create mode 100755 modules.d/97biosdevname/parse-biosdevname.sh

diff --git a/dracut.8 b/dracut.8
index ce39061..f7bb9ce 100644
--- a/dracut.8
+++ b/dracut.8
@@ -284,7 +284,9 @@ Required if multiple ip= lines are used.
 .TP
 .BR nameserver= "<IP> [nameserver=<IP> ...]"
 specify nameserver(s) to use
-
+.TP
+.BR biosdevname={0|1]}
+turn off/on biosdevname network interface renaming
 .SS NFS
 .TP
 .BR root= "[<server-ip>:]<root-dir>[:<nfs-options>]"
diff --git a/modules.d/97biosdevname/check b/modules.d/97biosdevname/check
new file mode 100755
index 0000000..f269c69
--- /dev/null
+++ b/modules.d/97biosdevname/check
@@ -0,0 +1,7 @@
+#!/bin/sh
+# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
+# ex: ts=8 sw=4 sts=4 et filetype=sh
+type -P biosdevname >/dev/null || exit 1
+
+# do not enable bootchartd by default
+exit 0
diff --git a/modules.d/97biosdevname/install b/modules.d/97biosdevname/install
new file mode 100755
index 0000000..ba45e91
--- /dev/null
+++ b/modules.d/97biosdevname/install
@@ -0,0 +1,14 @@
+# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
+# ex: ts=8 sw=4 sts=4 et filetype=sh
+dracut_install biosdevname
+inst_rules 71-biosdevname.rules
+inst_hook pre-trigger 30 "$moddir/parse-biosdevname.sh"
+
+# set the default state according to the config
+if [[ -e /etc/sysconfig/network ]]; then
+    . /etc/sysconfig/network
+fi
+
+if [[ "$BIOSDEVNAME" = "yes" ]]; then
+    echo "biosdevname=1" >> ${initdir}/etc/cmdline
+fi
diff --git a/modules.d/97biosdevname/parse-biosdevname.sh b/modules.d/97biosdevname/parse-biosdevname.sh
new file mode 100755
index 0000000..9b18d15
--- /dev/null
+++ b/modules.d/97biosdevname/parse-biosdevname.sh
@@ -0,0 +1,11 @@
+# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
+# ex: ts=8 sw=4 sts=4 et filetype=sh
+USE_BIOSDEVNAME=$(getarg biosdevname)
+if [[ $USE_BIOSDEVNAME != "1" ]]; then
+    udevproperty UDEV_BIOSDEVNAME=
+    rm -f /etc/udev/rules.d/71-biosdevname.rules
+else
+    info "biosdevname=1: activating biosdevname network renaming"
+    udevproperty UDEV_BIOSDEVNAME=1
+fi
+
