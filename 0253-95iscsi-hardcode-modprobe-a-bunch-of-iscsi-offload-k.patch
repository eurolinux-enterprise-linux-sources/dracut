From 69c9fb1122d2ee09cb0b9932887dbc05edc65701 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Tue, 18 Oct 2011 10:04:42 +0200
Subject: [PATCH] 95iscsi: hardcode modprobe a bunch of iscsi offload kernel
 drivers

---
 modules.d/95iscsi/installkernel      |  2 +-
 modules.d/95iscsi/parse-iscsiroot.sh | 17 ++++++++---------
 2 files changed, 9 insertions(+), 10 deletions(-)

diff --git a/modules.d/95iscsi/installkernel b/modules.d/95iscsi/installkernel
index e90f662..656c325 100755
--- a/modules.d/95iscsi/installkernel
+++ b/modules.d/95iscsi/installkernel
@@ -1,5 +1,5 @@
 #!/bin/bash
-instmods iscsi_tcp iscsi_ibft crc32c bnx2i iscsi_boot_sysfs
+instmods iscsi_tcp iscsi_ibft crc32c bnx2i iscsi_boot_sysfs qla4xxx cxgb3i cxgb4i be2iscsi
 iscsi_module_test() {
     local iscsifuncs='iscsi_register_transport'
     fgrep -q "$iscsifuncs" "$1"
diff --git a/modules.d/95iscsi/parse-iscsiroot.sh b/modules.d/95iscsi/parse-iscsiroot.sh
index e51a342..66bd268 100755
--- a/modules.d/95iscsi/parse-iscsiroot.sh
+++ b/modules.d/95iscsi/parse-iscsiroot.sh
@@ -50,17 +50,17 @@ if [ -n "$iscsiroot" ] ; then
     [ -z "$netroot" ] || [ "$netroot" = "iscsi" ] && netroot=iscsi:$iscsiroot
 fi
 
-if ! [ -e /sys/module/bnx2i ]; then
-    modprobe bnx2i 2>/dev/null
-    udevadm settle --timeout=30
-fi
+modprobe -q qla4xxx
+modprobe -q cxgb3i
+modprobe -q cxgb4i
+modprobe -q bnx2i
+modprobe -q be2iscsi
 
 # iscsi_firmware does not need argument checking
 if [ -n "$iscsi_firmware" ] ; then
     netroot=${netroot:-iscsi}
-    modprobe iscsi_ibft
-    modprobe iscsi_boot_sysfs 2>/dev/null
-    udevadm settle --timeout=30
+    modprobe -q iscsi_ibft
+    modprobe -q iscsi_boot_sysfs 2>/dev/null
 fi
 
 # If it's not iscsi we don't continue
@@ -75,8 +75,7 @@ fi
 
 # ISCSI actually supported?
 if ! [ -e /sys/module/iscsi_tcp ]; then
-    modprobe iscsi_tcp || die "iscsiroot requested but kernel/initrd does not support iscsi"
-    udevadm settle --timeout=30
+    modprobe -q iscsi_tcp || die "iscsiroot requested but kernel/initrd does not support iscsi"
 fi
 
 # Done, all good!
