From f53a0f20fdc13de3e4562b8c79eb60dbde6eea39 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Fri, 5 Sep 2014 16:05:42 +0200
Subject: [PATCH] proper debug for netroot and ifup

---
 modules.d/40network/ifup    | 12 ++++++------
 modules.d/40network/netroot |  5 ++++-
 2 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/modules.d/40network/ifup b/modules.d/40network/ifup
index 0aa7d86..f91900e 100755
--- a/modules.d/40network/ifup
+++ b/modules.d/40network/ifup
@@ -5,8 +5,14 @@
 #
 PATH=$PATH:/sbin:/usr/sbin
 
+export PS4="ifup.$1.$$ + "
+
 . /lib/dracut-lib.sh
 
+[ "$RDDEBUG" = "yes" ] \
+    && [ -e /dev/initlog.pipe ] \
+    && exec >>/dev/initlog.pipe 2>>/dev/initlog.pipe
+
 # Run dhclient
 do_dhcp() {
     # /sbin/dhclient-script will mark the netif up and generate the online
@@ -84,12 +90,6 @@ do_static() {
     /sbin/initqueue --onetime --name netroot-$netif  /sbin/netroot $netif 
 }
 
-PATH=$PATH:/sbin:/usr/sbin
-
-export PS4="ifup.$1.$$ + "
-exec >>/dev/initlog.pipe 2>>/dev/initlog.pipe
-. /lib/dracut-lib.sh
-
 # Huh? No $1?
 [ -z "$1" ] && exit 1
 
diff --git a/modules.d/40network/netroot b/modules.d/40network/netroot
index bd0dc55..8a2f852 100755
--- a/modules.d/40network/netroot
+++ b/modules.d/40network/netroot
@@ -3,7 +3,10 @@
 PATH=$PATH:/sbin:/usr/sbin
 
 . /lib/dracut-lib.sh
-setdebug
+
+[ "$RDDEBUG" = "yes" ] \
+    && [ -e /dev/initlog.pipe ] \
+    && exec >>/dev/initlog.pipe 2>>/dev/initlog.pipe
 
 # Huh? Empty $1?
 [ -z "$1" ] && exit 1
