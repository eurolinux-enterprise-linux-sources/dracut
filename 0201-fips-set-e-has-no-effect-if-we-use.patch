From 22f07c112d93c94d35e1c6384d2fb8421c0ab949 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 13 Apr 2011 14:35:12 +0200
Subject: [PATCH] fips: "set -e" has no effect, if we use "||"

---
 modules.d/01fips/fips-boot.sh   | 2 --
 modules.d/01fips/fips-noboot.sh | 2 --
 modules.d/01fips/fips.sh        | 4 ++--
 3 files changed, 2 insertions(+), 6 deletions(-)

diff --git a/modules.d/01fips/fips-boot.sh b/modules.d/01fips/fips-boot.sh
index fcae157..8e99e5e 100755
--- a/modules.d/01fips/fips-boot.sh
+++ b/modules.d/01fips/fips-boot.sh
@@ -6,7 +6,5 @@ if ! fipsmode=$(getarg fips) || [ $fipsmode = "0" ]; then
     rm -f /etc/modprobe.d/fips.conf >/dev/null 2>&1
 elif getarg boot= >/dev/null; then
     . /sbin/fips.sh
-    set -e
     do_fips || die "FIPS integrity test failed"
-    set +e
 fi
diff --git a/modules.d/01fips/fips-noboot.sh b/modules.d/01fips/fips-noboot.sh
index d6c2e2f..107728c 100755
--- a/modules.d/01fips/fips-noboot.sh
+++ b/modules.d/01fips/fips-noboot.sh
@@ -6,7 +6,5 @@ if ! fipsmode=$(getarg fips) || [ $fipsmode = "0" ]; then
     rm -f /etc/modprobe.d/fips.conf >/dev/null 2>&1
 elif ! getarg boot= >/dev/null; then
     . /sbin/fips.sh
-    set -e
     do_fips || die "FIPS integrity test failed"
-    set +e
 fi
diff --git a/modules.d/01fips/fips.sh b/modules.d/01fips/fips.sh
index 1ae01cf..360955c 100755
--- a/modules.d/01fips/fips.sh
+++ b/modules.d/01fips/fips.sh
@@ -33,11 +33,11 @@ do_fipskernel()
             fi
         fi
 
-        [ -e "$boot" ]
+        [ -e "$boot" ] || return 1
         
         mkdir /boot
         info "Mounting $boot as /boot"
-        mount -oro "$boot" /boot
+        mount -oro "$boot" /boot || return 1
         unset newroot
     fi
 
