From e484218385e19e7dff4793c2ab132d259aabb103 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 27 Jan 2010 16:09:15 +0100
Subject: [PATCH] base: fix selinux handling if .autorelabel is present

rhbz#557744
---
 modules.d/99base/selinux-loadpolicy.sh | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/modules.d/99base/selinux-loadpolicy.sh b/modules.d/99base/selinux-loadpolicy.sh
index 9e95b8d..5b91ee6 100755
--- a/modules.d/99base/selinux-loadpolicy.sh
+++ b/modules.d/99base/selinux-loadpolicy.sh
@@ -37,6 +37,8 @@ rd_load_policy()
 	} 2>&1 | vinfo
 
 	if [ $ret -eq 0 -o $ret -eq 2 ]; then
+	    # If machine requires a relabel, force to permissive mode
+	    [ -e "$NEWROOT"/.autorelabel ] && ( echo 0 > "$NEWROOT"/selinux/enforce )
 	    return 0
 	fi
 
