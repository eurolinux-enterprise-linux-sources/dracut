From 6b086476498d203494777ca66720f6f813cf77e1 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Tue, 20 Sep 2011 15:36:14 +0200
Subject: [PATCH] 90mdraid/mdadm_auto.sh: incrementally autoassemble

moved "mdadm -As --run" to the timeout script
---
 modules.d/90mdraid/65-md-incremental-imsm.rules | 10 ----------
 modules.d/90mdraid/mdadm_auto.sh                |  2 +-
 modules.d/90mdraid/mdraid_start.sh              |  6 +++++-
 3 files changed, 6 insertions(+), 12 deletions(-)

diff --git a/modules.d/90mdraid/65-md-incremental-imsm.rules b/modules.d/90mdraid/65-md-incremental-imsm.rules
index 0eaaf83..2548e14 100644
--- a/modules.d/90mdraid/65-md-incremental-imsm.rules
+++ b/modules.d/90mdraid/65-md-incremental-imsm.rules
@@ -22,16 +22,6 @@ KERNEL!="md*", IMPORT{program}="/sbin/mdadm --examine --export $tempnode"
 
 LABEL="do_md_inc"
 
-# 
-# if rd_MDADMCONF do not assemble incrementally
-# defer auto assembly until the udev queue is settled
-# 
-ENV{rd_MDADMCONF}!="?*", GOTO="md_auto_end"
-
-RUN+="/bin/sh -c 'ln -s /sbin/md_finished.sh /initqueue-finished/md_finished.sh;/sbin/initqueue --settled --onetime --unique /sbin/mdadm_auto'"
-
-GOTO="md_inc_end"
-
 LABEL="md_auto_end"
 
 #
diff --git a/modules.d/90mdraid/mdadm_auto.sh b/modules.d/90mdraid/mdadm_auto.sh
index a971a5a..52e8fce 100755
--- a/modules.d/90mdraid/mdadm_auto.sh
+++ b/modules.d/90mdraid/mdadm_auto.sh
@@ -2,4 +2,4 @@
 . /lib/dracut-lib.sh
 
 info "Autoassembling MD Raid"    
-/sbin/mdadm -As --auto=yes --run 2>&1 | vinfo
+/sbin/mdadm -As --auto=yes 2>&1 | vinfo
diff --git a/modules.d/90mdraid/mdraid_start.sh b/modules.d/90mdraid/mdraid_start.sh
index 50c8908..6499c4c 100755
--- a/modules.d/90mdraid/mdraid_start.sh
+++ b/modules.d/90mdraid/mdraid_start.sh
@@ -1,9 +1,13 @@
 #!/bin/sh
 
 . /lib/dracut-lib.sh
+udevadm control --stop-exec-queue
+
 # run mdadm if udev has settled
+info "Autoassembling MD Raid"    
+/sbin/mdadm -As --auto=yes 2>&1 | vinfo
+
 info "Assembling MD RAID arrays"
-udevadm control --stop-exec-queue
 mdadm -IRs 2>&1 | vinfo
 
 # there could still be some leftover devices
