From 5678b583f380479bd3f8c1f31300b4ca80c03f14 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Thu, 18 Aug 2011 15:52:32 +0200
Subject: [PATCH] iscsi: bnx2i

---
 modules.d/95iscsi/install            | 1 +
 modules.d/95iscsi/installkernel      | 2 +-
 modules.d/95iscsi/iscsiroot          | 2 ++
 modules.d/95iscsi/parse-iscsiroot.sh | 2 ++
 4 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/modules.d/95iscsi/install b/modules.d/95iscsi/install
index 6386410..44e53f9 100755
--- a/modules.d/95iscsi/install
+++ b/modules.d/95iscsi/install
@@ -3,6 +3,7 @@ dracut_install umount
 inst iscsistart 
 inst hostname
 inst iscsi-iname
+type -P iscsiuio >/dev/null && inst iscsiuio
 inst_hook cmdline 90 "$moddir/parse-iscsiroot.sh"
 inst "$moddir/iscsiroot" "/sbin/iscsiroot"
 inst "$moddir/mount-lun.sh" "/bin/mount-lun.sh"
diff --git a/modules.d/95iscsi/installkernel b/modules.d/95iscsi/installkernel
index 2695f84..9806a5a 100755
--- a/modules.d/95iscsi/installkernel
+++ b/modules.d/95iscsi/installkernel
@@ -1,5 +1,5 @@
 #!/bin/bash
-instmods iscsi_tcp iscsi_ibft crc32c
+instmods iscsi_tcp iscsi_ibft crc32c bnx2i
 iscsi_module_test() {
     local iscsifuncs='iscsi_register_transport'
     fgrep -q "$iscsifuncs" "$1"
diff --git a/modules.d/95iscsi/iscsiroot b/modules.d/95iscsi/iscsiroot
index b3b00c3..0bf6726 100755
--- a/modules.d/95iscsi/iscsiroot
+++ b/modules.d/95iscsi/iscsiroot
@@ -38,6 +38,8 @@ modprobe crc32c 2>/dev/null
 
 [ -e /tmp/root.info ] && . /tmp/root.info
 
+[ -e /sys/module/bnx2i ] && iscsiuio
+
 if getarg iscsi_firmware ; then
     if [ -n "${root%%block:*}" ]; then
         # if root is not specified try to mount the whole iSCSI LUN
diff --git a/modules.d/95iscsi/parse-iscsiroot.sh b/modules.d/95iscsi/parse-iscsiroot.sh
index 7b82b10..43cb9b9 100755
--- a/modules.d/95iscsi/parse-iscsiroot.sh
+++ b/modules.d/95iscsi/parse-iscsiroot.sh
@@ -50,6 +50,8 @@ if [ -n "$iscsiroot" ] ; then
     [ -z "$netroot" ] || [ "$netroot" = "iscsi" ] && netroot=iscsi:$iscsiroot
 fi
 
+modprobe bnx2i 2>/dev/null
+
 # iscsi_firmware does not need argument checking
 if [ -n "$iscsi_firmware" ] ; then
     netroot=${netroot:-iscsi}
