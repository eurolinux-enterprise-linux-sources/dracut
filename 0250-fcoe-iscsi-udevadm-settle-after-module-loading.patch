From 4fa79aedff75a2f75f106fb357d43dbfe79e6ed8 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Mon, 10 Oct 2011 13:31:42 +0200
Subject: [PATCH] fcoe/iscsi: udevadm settle after module loading

---
 modules.d/95fcoe/fcoe-up             |  1 +
 modules.d/95fcoe/parse-fcoe.sh       |  1 +
 modules.d/95iscsi/parse-iscsiroot.sh | 12 ++++++++++--
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/modules.d/95fcoe/fcoe-up b/modules.d/95fcoe/fcoe-up
index ae5eeea..28f7556 100755
--- a/modules.d/95fcoe/fcoe-up
+++ b/modules.d/95fcoe/fcoe-up
@@ -39,6 +39,7 @@ if [ "$dcb" = "dcb" ]; then
 elif [ "$netdriver" = "bnx2x" ]; then
     # If driver is bnx2x, do not use /sys/module/fcoe/parameters/create but fipvlan
     modprobe 8021q
+    udevadm settle --timeout=30
     fipvlan "$netif" -c -s
 else
     echo -n "$netif" > /sys/module/fcoe/parameters/create
diff --git a/modules.d/95fcoe/parse-fcoe.sh b/modules.d/95fcoe/parse-fcoe.sh
index 3827cbb..8c3c61e 100755
--- a/modules.d/95fcoe/parse-fcoe.sh
+++ b/modules.d/95fcoe/parse-fcoe.sh
@@ -23,6 +23,7 @@
 [ -e /sys/module/fcoe/parameters/create ] || modprobe -a fcoe || die "FCoE requested but kernel/initrd does not support FCoE"
 
 modprobe bnx2fc >/dev/null 2>&1
+udevadm settle --timeout=30
 
 parse_fcoe_opts() {
     local IFS=:
diff --git a/modules.d/95iscsi/parse-iscsiroot.sh b/modules.d/95iscsi/parse-iscsiroot.sh
index 1c4e72d..e51a342 100755
--- a/modules.d/95iscsi/parse-iscsiroot.sh
+++ b/modules.d/95iscsi/parse-iscsiroot.sh
@@ -50,12 +50,17 @@ if [ -n "$iscsiroot" ] ; then
     [ -z "$netroot" ] || [ "$netroot" = "iscsi" ] && netroot=iscsi:$iscsiroot
 fi
 
-[ -e /sys/module/bnx2i ] || modprobe bnx2i 2>/dev/null
+if ! [ -e /sys/module/bnx2i ]; then
+    modprobe bnx2i 2>/dev/null
+    udevadm settle --timeout=30
+fi
 
 # iscsi_firmware does not need argument checking
 if [ -n "$iscsi_firmware" ] ; then
     netroot=${netroot:-iscsi}
     modprobe iscsi_ibft
+    modprobe iscsi_boot_sysfs 2>/dev/null
+    udevadm settle --timeout=30
 fi
 
 # If it's not iscsi we don't continue
@@ -69,7 +74,10 @@ if [ -z "$iscsi_firmware" ] ; then
 fi
 
 # ISCSI actually supported?
-[ -e /sys/module/iscsi_tcp ] || modprobe iscsi_tcp || die "iscsiroot requested but kernel/initrd does not support iscsi"
+if ! [ -e /sys/module/iscsi_tcp ]; then
+    modprobe iscsi_tcp || die "iscsiroot requested but kernel/initrd does not support iscsi"
+    udevadm settle --timeout=30
+fi
 
 # Done, all good!
 rootok=1
