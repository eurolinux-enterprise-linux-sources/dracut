From d65cf005bb56de97ee8fb618f3c0d69934a8a540 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Fri, 5 Sep 2014 14:40:13 +0200
Subject: [PATCH] iscsi/parse-iscsiroot.sh: honor blacklist for modprobe

---
 modules.d/95iscsi/iscsiroot          |  5 -----
 modules.d/95iscsi/parse-iscsiroot.sh | 17 +++++++++--------
 2 files changed, 9 insertions(+), 13 deletions(-)

diff --git a/modules.d/95iscsi/iscsiroot b/modules.d/95iscsi/iscsiroot
index dce081d..b6b2ad7 100755
--- a/modules.d/95iscsi/iscsiroot
+++ b/modules.d/95iscsi/iscsiroot
@@ -31,11 +31,6 @@ source_all /etc/conf.d
 
 iroot=${iroot#iscsi:}
 
-# XXX modprobe crc32c should go in the cmdline parser, but I haven't yet
-# figured out a way how to check whether this is built-in or not
-modprobe crc32c 2>/dev/null
-
-
 [ -e /tmp/root.info ] && . /tmp/root.info
 
 [ -e /sys/module/bnx2i ] && iscsiuio
diff --git a/modules.d/95iscsi/parse-iscsiroot.sh b/modules.d/95iscsi/parse-iscsiroot.sh
index 0e3169f..2bbf3b9 100755
--- a/modules.d/95iscsi/parse-iscsiroot.sh
+++ b/modules.d/95iscsi/parse-iscsiroot.sh
@@ -53,17 +53,18 @@ if [ -n "$iscsiroot" ] ; then
     [ -z "$netroot" ] || [ "$netroot" = "iscsi" ] && netroot=iscsi:$iscsiroot
 fi
 
-modprobe -q qla4xxx
-modprobe -q cxgb3i
-modprobe -q cxgb4i
-modprobe -q bnx2i
-modprobe -q be2iscsi
+modprobe -q -b qla4xxx
+modprobe -q -b cxgb3i
+modprobe -q -b cxgb4i
+modprobe -q -b bnx2i
+modprobe -q -b be2iscsi
+modprobe -q -b crc32c
 
 # iscsi_firmware does not need argument checking
 if [ -n "$iscsi_firmware" ] ; then
     netroot=${netroot:-iscsi}
-    modprobe -q iscsi_ibft
-    modprobe -q iscsi_boot_sysfs 2>/dev/null
+    modprobe -q -b iscsi_ibft
+    modprobe -q -b iscsi_boot_sysfs 2>/dev/null
     echo "[ -f '/tmp/iscsistarted-firmware' ]" > /initqueue-finished/iscsi_firmware_started.sh
 fi
 
@@ -76,7 +77,7 @@ fi
 
 # ISCSI actually supported?
 if ! [ -e /sys/module/iscsi_tcp ]; then
-    modprobe -q iscsi_tcp || die "iscsiroot requested but kernel/initrd does not support iscsi"
+    modprobe -q -b iscsi_tcp || die "iscsiroot requested but kernel/initrd does not support iscsi"
 fi
 
 if [ -n "$iscsi_firmware" ] || \
