From 724674d178a2ebcb08a148eed3ab083b4fbfab41 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Fri, 5 Sep 2014 14:40:42 +0200
Subject: [PATCH] iscsi/iscsiroot: call iscsiroot in the background only once

---
 modules.d/95iscsi/iscsiroot | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/modules.d/95iscsi/iscsiroot b/modules.d/95iscsi/iscsiroot
index b6b2ad7..c5b0cdb 100755
--- a/modules.d/95iscsi/iscsiroot
+++ b/modules.d/95iscsi/iscsiroot
@@ -35,17 +35,18 @@ iroot=${iroot#iscsi:}
 
 [ -e /sys/module/bnx2i ] && iscsiuio
 
-if getarg iscsi_firmware ; then
+if getarg iscsi_firmware && ! [ -f /tmp/iscsistarted-firmware ]; then
     if [ -n "${root%%block:*}" ]; then
         # if root is not specified try to mount the whole iSCSI LUN
-	printf 'ENV{DEVTYPE}!="partition", SYMLINK=="disk/by-path/*-iscsi-*-*", SYMLINK+="root"\n' >> /etc/udev/rules.d/99-iscsi-root.rules
+        printf 'ENV{DEVTYPE}!="partition", SYMLINK=="disk/by-path/*-iscsi-*-*", SYMLINK+="root"\n' >> /etc/udev/rules.d/99-iscsi-root.rules
     fi
 
     for p in $(getargs iscsi_param); do
-	iscsi_param="$iscsi_param --param $p"
+        iscsi_param="$iscsi_param --param $p"
     done
 
-    iscsistart -b $iscsi_param
+    iscsistart -N
+    iscsistart -b $iscsi_param </dev/null >>/tmp/iscsiroot.out 2>&1&
 
     echo 'started' > "/tmp/iscsistarted-iscsi"
     echo 'started' > "/tmp/iscsistarted-firmware"
