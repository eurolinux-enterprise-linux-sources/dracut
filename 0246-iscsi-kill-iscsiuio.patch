From 584ee33fa02c3b38a964ea86b389a529a5cd4722 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 28 Sep 2011 16:03:40 +0200
Subject: [PATCH] iscsi:  kill iscsiuio

https://bugzilla.redhat.com/show_bug.cgi?id=701864
---
 modules.d/95iscsi/cleanup-iscsi.sh | 6 ++++++
 modules.d/95iscsi/install          | 1 +
 2 files changed, 7 insertions(+)
 create mode 100755 modules.d/95iscsi/cleanup-iscsi.sh

diff --git a/modules.d/95iscsi/cleanup-iscsi.sh b/modules.d/95iscsi/cleanup-iscsi.sh
new file mode 100755
index 0000000..a2d5951
--- /dev/null
+++ b/modules.d/95iscsi/cleanup-iscsi.sh
@@ -0,0 +1,6 @@
+#!/bin/sh
+# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
+# ex: ts=8 sw=4 sts=4 et filetype=sh
+
+[ -e /sys/module/bnx2i ] && killproc iscsiuio
+
diff --git a/modules.d/95iscsi/install b/modules.d/95iscsi/install
index 44e53f9..1915667 100755
--- a/modules.d/95iscsi/install
+++ b/modules.d/95iscsi/install
@@ -5,5 +5,6 @@ inst hostname
 inst iscsi-iname
 type -P iscsiuio >/dev/null && inst iscsiuio
 inst_hook cmdline 90 "$moddir/parse-iscsiroot.sh"
+inst_hook pre-pivot 90 "$moddir/cleanup-iscsi.sh"
 inst "$moddir/iscsiroot" "/sbin/iscsiroot"
 inst "$moddir/mount-lun.sh" "/bin/mount-lun.sh"
