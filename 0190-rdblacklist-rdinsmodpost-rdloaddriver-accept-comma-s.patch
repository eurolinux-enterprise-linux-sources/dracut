From 60e4486b5346e0e88a36ee0a89d4acc431d7b839 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 9 Mar 2011 21:51:16 +0100
Subject: [PATCH] rdblacklist, rdinsmodpost, rdloaddriver: accept comma
 separated list

---
 dracut-rhel6.xml                           |  6 +++---
 modules.d/90kernel-modules/parse-kernel.sh | 10 ++++++++--
 modules.d/96insmodpost/insmodpost.sh       |  9 +++++++--
 modules.d/99base/parse-blacklist.sh        |  9 +++++++--
 4 files changed, 25 insertions(+), 9 deletions(-)

diff --git a/dracut-rhel6.xml b/dracut-rhel6.xml
index 612416b..811db9e 100644
--- a/dracut-rhel6.xml
+++ b/dracut-rhel6.xml
@@ -1130,7 +1130,7 @@
             <variablelist>
               <varlistentry>
                 <term>
-                  <envar>rdblacklist=<replaceable>&lt;drivername&gt;</replaceable></envar>
+                  <envar>rdblacklist=<replaceable>&lt;drivername&gt;<optional>,&lt;drivername&gt;,...</optional></replaceable></envar>
                 </term>
                 <listitem>
                   <para>do not load kernel module &lt;drivername&gt;
@@ -1139,7 +1139,7 @@
               </varlistentry>
               <varlistentry>
                 <term>
-                  <envar>rdloaddriver=<replaceable>&lt;drivername&gt;</replaceable></envar>
+                  <envar>rdloaddriver=<replaceable>&lt;drivername&gt;<optional>,&lt;drivername&gt;,...</optional></replaceable></envar>
                 </term>
                 <listitem>
                   <para>force loading kernel module &lt;drivername&gt;
@@ -1148,7 +1148,7 @@
               </varlistentry>
               <varlistentry>
                 <term>
-                  <envar>rdrdinsmodpost=<replaceable>&lt;drivername&gt;</replaceable></envar>
+                  <envar>rdrdinsmodpost=<replaceable>&lt;drivername&gt;<optional>,&lt;drivername&gt;,...</optional></replaceable></envar>
                 </term>
                 <listitem>
                   <para>force loading kernel module &lt;drivername&gt; after all automatic loading modules have been loaded. This parameter can be specified multiple times.</para>
diff --git a/modules.d/90kernel-modules/parse-kernel.sh b/modules.d/90kernel-modules/parse-kernel.sh
index 6278dac..9ed5448 100755
--- a/modules.d/90kernel-modules/parse-kernel.sh
+++ b/modules.d/90kernel-modules/parse-kernel.sh
@@ -1,5 +1,11 @@
 #!/bin/sh
 
-for p in $(getargs rdloaddriver=); do 
-	modprobe $p
+for i in $(getargs rdloaddriver=); do 
+    ( 
+        IFS=,
+        for p in $i; do 
+            modprobe $p 2>&1 | vinfo
+        done
+    )
 done
+
diff --git a/modules.d/96insmodpost/insmodpost.sh b/modules.d/96insmodpost/insmodpost.sh
index f3bd780..0b162c5 100755
--- a/modules.d/96insmodpost/insmodpost.sh
+++ b/modules.d/96insmodpost/insmodpost.sh
@@ -3,6 +3,11 @@
 # ex: ts=8 sw=4 sts=4 et filetype=sh
 . /lib/dracut-lib.sh
 
-for p in $(getargs rdinsmodpost=); do 
-    modprobe $p
+for i in $(getargs rdinsmodpost=); do 
+    (
+        IFS=,
+        for p in $i; do 
+            modprobe $p
+        done
+    )
 done
diff --git a/modules.d/99base/parse-blacklist.sh b/modules.d/99base/parse-blacklist.sh
index 7020b31..71d8680 100755
--- a/modules.d/99base/parse-blacklist.sh
+++ b/modules.d/99base/parse-blacklist.sh
@@ -1,5 +1,10 @@
 #!/bin/sh
 
-for p in $(getargs rdblacklist=); do 
-     echo "blacklist $p" >> /etc/modprobe.d/initramfsblacklist.conf
+for i in $(getargs rdblacklist=); do 
+    (
+        IFS=,
+	for p in $i; do 
+            echo "blacklist $p" >> /etc/modprobe.d/initramfsblacklist.conf
+	done
+    )
 done
