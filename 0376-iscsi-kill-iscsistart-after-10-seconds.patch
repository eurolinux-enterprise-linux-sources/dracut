From 0aa4e3149f2546c1e8afeb408e704c92f7d5a1cf Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Fri, 8 May 2015 13:48:00 +0200
Subject: [PATCH] iscsi: kill iscsistart after 10 seconds

starting several iscsistart in parallel does not work reliably
---
 modules.d/95iscsi/iscsiroot | 32 +++++++++++++++++++-------------
 1 file changed, 19 insertions(+), 13 deletions(-)

diff --git a/modules.d/95iscsi/iscsiroot b/modules.d/95iscsi/iscsiroot
index e2d6a5f..671c56a 100755
--- a/modules.d/95iscsi/iscsiroot
+++ b/modules.d/95iscsi/iscsiroot
@@ -144,19 +144,25 @@ handle_netroot()
     > /initqueue/work
 
     iscsistart -i $iscsi_initiator -t $iscsi_target_name	\
-	-g $iscsi_target_group -a $iscsi_target_ip	\
-	-p $iscsi_target_port \
-	${iscsi_username+-u $iscsi_username} \
-	${iscsi_password+-w $iscsi_password} \
-	${iscsi_in_username+-U $iscsi_in_username} \
-	${iscsi_in_password+-W $iscsi_in_password} \
-	${iscsi_iface_name+--param iface.iscsi_ifacename=$iscsi_iface_name} \
-	${iscsi_netdev_name+--param iface.net_ifacename=$iscsi_netdev_name} \
-	${iscsi_param} \
-	&
-
-
-    echo '! pidof iscsistart >/dev/null 2>&1' > /initqueue-finished/iscsistart_stopped.sh
+	       -g $iscsi_target_group -a $iscsi_target_ip	\
+	       -p $iscsi_target_port \
+	       ${iscsi_username+-u $iscsi_username} \
+	       ${iscsi_password+-w $iscsi_password} \
+	       ${iscsi_in_username+-U $iscsi_in_username} \
+	       ${iscsi_in_password+-W $iscsi_in_password} \
+	       ${iscsi_iface_name+--param iface.iscsi_ifacename=$iscsi_iface_name} \
+	       ${iscsi_netdev_name+--param iface.net_ifacename=$iscsi_netdev_name} \
+	       ${iscsi_param} \
+    &
+
+    # give 10 seconds to connect to the iscsi target
+    _cnt=0
+    while [ $_cnt -lt 100 ]; do
+        pidof iscsistart || break
+        sleep 0.1
+        _cnt=$(($_cnt+1))
+    done
+    [ $_cnt -lt 100 ] || killproc iscsistart
 
     netroot_enc=$(str_replace "$1" '/' '\2f')
     echo 'started' > "/tmp/iscsistarted-iscsi:${netroot_enc}"
